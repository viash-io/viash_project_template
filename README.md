Viash project template
================

<!-- README.md is generated from README.qmd using quarto render. Please edit that file -->
<p align="center">
<a href="https://viash.io/">
<img alt="viash" src="https://viash.io/logo/viash_large.svg" width="300">
</a>
</p>

This repository is a template for setting up a new
[Viash](https://viash.io) project.

## Setup

After forking this repository / using this template, you will need to
clone the repository and run the following commands to install Viash and
Nextflow in the `$HOME/bin/` directory. Make sure this directory is on
your `$PATH`.

``` sh
# download viash in the $HOME/bin folder
curl -fsSL get.viash.io | bash -s -- --tools false --bin $HOME/bin

# also download nextflow in the $HOME/bin folder
curl -s https://get.nextflow.io | bash
mv nextflow $HOME/bin
```

## Contents of this template

This template repo contains the following content:

    .
    ├── LICENSE.md                            License information
    ├── README.qmd                            The source qmd file for this readme
    ├── README.md                             This readme
    ├── _viash.yaml                           Global Viash settings
    ├── resources_test/*.tsv                  Sample files to showcase pipeline and
    │   ├── file1.tsv                         run component unit tests.
    │   └── file2.tsv
    ├── src/demo                              Source directory with Viash components
    │   ├── combine_columns
    │   ├── remove_comments
    │   └── take_column
    ├── target                                Target platform files generated by Viash
    │   ├── docker                            Executables generated from source
    │   └── nextflow                          Nextflow modules generated from source
    └── workflows
        └── demo_pipeline                     Demo Nextflow pipeline
            ├── main.nf
            └── nextflow.config

## First development build

You can generate your first development build by running:

``` sh
viash ns build --setup cachedbuild --parallel
```

    Exporting combine_columns (demo) =docker=> /home/rcannood/workspace/viash-io/viash_project_template/target/docker/demo/combine_columns
    Exporting combine_columns (demo) =nextflow=> /home/rcannood/workspace/viash-io/viash_project_template/target/nextflow/demo/combine_columns
    Exporting remove_comments (demo) =docker=> /home/rcannood/workspace/viash-io/viash_project_template/target/docker/demo/remove_comments
    Exporting remove_comments (demo) =nextflow=> /home/rcannood/workspace/viash-io/viash_project_template/target/nextflow/demo/remove_comments
    Exporting take_column (demo) =nextflow=> /home/rcannood/workspace/viash-io/viash_project_template/target/nextflow/demo/take_column
    Exporting take_column (demo) =docker=> /home/rcannood/workspace/viash-io/viash_project_template/target/docker/demo/take_column
    [notice] Building container 'ghcr.io/viash-io/viash_project_template/demo_take_column:dev' with Dockerfile
    [notice] Building container 'ghcr.io/viash-io/viash_project_template/demo_remove_comments:dev' with Dockerfile
    [notice] Building container 'ghcr.io/viash-io/viash_project_template/demo_combine_columns:dev' with Dockerfile
    All 6 configs built successfully

The demo Nextflow pipeline uses these components to process text files
(in `resources_test/`) in a certain way. You can run the following
command to run the pipeline.

``` sh
NXF_VER=22.10.4 nextflow \
  run . \
  -main-script workflows/demo_pipeline/main.nf \
  -with-docker \
  --input resources_test/file*.tsv \
  --publishDir temp
```

    N E X T F L O W  ~  version 22.10.4
    Launching workflows/demo_pipeline/main.nf` [fervent_sammet] DSL2 - revision: c65d4e7bba
    [0a/b62556] Submitted process > remove_comments:remove_comments_process (file1)
    [bf/5a0438] Submitted process > take_column:take_column_process (file1)
    [f9/549a1e] Submitted process > combine_columns:combine_columns_process (combined)
    Output: [combined, work/f9/549a1e5a450bdb5837312c85a4767f/combined.combine_columns.output]

## Customising the project

Generally, it’s a good idea to edit the `_viash.yaml` by filling the
details of your own repository here.

If you want to start from a clean repository, remove the contents of the
`resources_test/`, `src/`, and `workflows/` directories.

## Unit testing

You can unit test all Viash components using the following command:

``` sh
viash ns test --parallel
```

    The working directory for the namespace tests is /home/rcannood/workspace/viash_temp/viash_ns_test17436153066841085346
               namespace        functionality             platform            test_name exit_code duration               result
                    demo      remove_comments               docker                start                                        
                    demo          take_column               docker                start                                        
                    demo      combine_columns               docker                start                                        
                    demo      combine_columns               docker     build_executable         0        9              SUCCESS
                    demo      combine_columns               docker                tests        -1        0              MISSING
    no tests found
    ====================================================================
                    demo      remove_comments               docker     build_executable         0        5              SUCCESS
                    demo      remove_comments               docker              test.sh         0        5              SUCCESS
                    demo          take_column               docker     build_executable         0       12              SUCCESS
                    demo          take_column               docker                tests        -1        0              MISSING
    no tests found
    ====================================================================
    Not all configs built and tested successfully
      2/6 tests missing
      4/6 configs built and tested successfully

## Creating a release (manually)

The script below assumes you have a separate clone of this repository
specifically for building a release. To do so, switch to the release
branch, merge all changes from the main branch, build all components and
push the new release to Github and the containers to your Docker
registry of choice.

One time setup

``` sh
# clone repo
git clone git@github.com:myusername/demo_pipeline.git demo_pipeline_release
cd demo_pipeline_release

# switch to release branch
git checkout release

# allow publishing the target folder
sed -i '/^target.*/d' .gitignore
git add .gitignore
git commit -m "update gitignore for release"
```

For every build

``` sh
TAG=0.2.0

# merge latest changes in the release branch
rm -r target
git fetch origin
git merge origin/main

# build target folder and docker containers
viash ns build --setup build --config_mod ".functionality.version := '$TAG'" --parallel

# run unit tests (ideally, these should all pass)
viash ns test --config_mod ".functionality.version := '$TAG'" --parallel

# push docker containers to container registry
viash ns build --config_mod ".functionality.version := '$TAG'" --setup push

# commit current code to release branch
git add target
git commit -m "Release $TAG"
git push

# create new tag
git tag -a "$TAG" -m "Release $TAG"
git push --tags
```

## Running a pipeline from release

When a release has been made, you can run the pipeline as follows:

``` sh
NXF_VER=22.10.4 nextflow \
  run https://github.com/viash-io/viash_project_template \
  -main-script workflows/demo_pipeline/main.nf \
  -r 0.2.0 \
  -resume -latest \
  -with-docker \
  --input resources_test/file*.tsv \
  --publishDir temp
```

    Cannot find revision `0.2.0` -- Make sure that it exists in the remote repository `https://github.com/viash-io/viash_project_template`
    N E X T F L O W  ~  version 22.10.4
    Pulling viash-io/viash_project_template ...

Since all the components and containers are published on Github, this
pipeline should be 100% reproducible.

## Documentation

The Viash documentation is available online at
[`viash.io`](https://viash.io).

## License

Copyright (C) 2020 Data Intuitive

This program is free software: you can redistribute it and/or modify it
under the terms of the GNU General Public License as published by the
Free Software Foundation, either version 3 of the License, or (at your
option) any later version.

This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General
Public License for more details.

You should have received a copy of the GNU General Public License along
with this program. If not, see <http://www.gnu.org/licenses/>.
